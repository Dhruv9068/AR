<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js ar - hit test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link type="text/css" rel="stylesheet" href="ARstyle.css">
    <script src="new.js"></script>
    
</head>
<body>

<div id="content">
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>


        <!-- Links for AR objects -->
        <a class="ar-object" id="1" href="#">item_1</a>
        <a class="ar-object" id="2" href="#">item_2</a>
        <a class="ar-object" id="3" href="#">item_3</a>
        <a class="ar-object" id="4" href="#">item_4</a>
        <a class="ar-object" id="5" href="#">item_5</a>
        <a class="ar-object" id="6" href="#">item_6</a>
        <a class="ar-object" id="7" href="#">item_7</a>
        <a class="ar-object" id="8" href="#">item_8</a>
       
        <div id="container" style="position: fixed;"></div>
         
    
   

    </div>

    <div id="container" style="position: fixed;"></div>
   
    <span style="font-size:30px;cursor:pointer;position: absolute;" onclick="openNav()">&#9776;  <i class="fas fa-shopping-cart"></i> Cart</span>
</div>
    <button type="button" id="place-button">PLACE</button>
</div>

<div class="con">
<div class="Instructions">
    <h2>Instructions</h2>
    <p>Enable AR mode button from below</p>
    <p>Select a 3D model from the sidebar to place it in the AR scene.</p>
    <p>Use the "PLACE" button to position the selected model in the AR environment.</p>
    <p>To view the AR content, ensure that your device supports AR and you have granted camera permissions.</p>
</div>
</div>
<script>
    function openNav() {
        document.getElementById("mySidenav").style.width = "250px";
    }
    
    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
    }

    const filterCartItems = () => {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartProductIds = cart.map(item => item.product_id.toString()); // Ensure IDs are strings
 
            document.querySelectorAll('.ar-object').forEach(link => {
                if (cartProductIds.includes(link.id)) {
                    link.style.display = 'inline'; // Show the item
                } else {
                    link.style.display = 'none'; // Hide the item
                }
            });
 
            if (cartProductIds.length === 0) {
                const message = document.createElement('p');
                message.textContent = 'No items in the cart.';
                document.body.appendChild(message);
            }
        };
        filterCartItems();
</script>

<script type="module">
    import * as THREE from './build/three.module.js';
    import { ARButton } from './jsm/webxr/ARButton.js';
    import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
    import { RGBELoader } from './jsm/loaders/RGBELoader.js';
    import { OrbitControls } from './jsm/controls/OrbitControls.js';

    var container;
    var camera, scene, renderer;
    var reticle, pmremGenerator, current_object, controls, isAR, envmap;
    var hitTestSource = null;
    var hitTestSourceRequested = false;
    var selectedModel = null; // Track the selected model

    init();
    animate();

    function init() {
        container = document.createElement('div');
        document.getElementById('container').appendChild(container);

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);

        var directionalLight = new THREE.DirectionalLight(0xdddddd, 1);
        directionalLight.position.set(0, 0, 1).normalize();
        scene.add(directionalLight);

        var ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        container.appendChild(renderer.domElement);

        pmremGenerator = new THREE.PMREMGenerator(renderer);
        pmremGenerator.compileEquirectangularShader();

        controls = new OrbitControls(camera, renderer.domElement);
        controls.addEventListener('change', render);
        controls.minDistance = 2;
        controls.maxDistance = 10;
        controls.target.set(0, 0, -0.2);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        let options = {
            requiredFeatures: ['hit-test'],
            optionalFeatures: ['dom-overlay'],
        };

        options.domOverlay = { root: document.getElementById('content') };
        document.body.appendChild(ARButton.createButton(renderer, options));

        reticle = new THREE.Mesh(
            new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
            new THREE.MeshBasicMaterial()
        );
        reticle.matrixAutoUpdate = false;
        reticle.visible = false;
        scene.add(reticle);

        window.addEventListener('resize', onWindowResize, false);

        // Handle sidebar object clicks
        document.querySelectorAll('.ar-object').forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                selectedModel = link.id + ".glb"; // Set selected model based on ID
                console.log('Selected model:', selectedModel); // For debugging
            });
        });

        document.getElementById('place-button').addEventListener('click', arPlace);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function arPlace() {
        if (reticle.visible && selectedModel) {
            new GLTFLoader().setPath('3d/').load(selectedModel, function(glb) {
                if (current_object) {
                    scene.remove(current_object); // Remove previous object if exists
                }
                current_object = glb.scene;
                current_object.position.setFromMatrixPosition(reticle.matrix);
                scene.add(current_object);
                current_object.visible = true;
            });
        }
    }

    function animate() {
        renderer.setAnimationLoop(render);
        requestAnimationFrame(animate);
        controls.update();
    }

    function render(timestamp, frame) {
        if (frame && isAR) {
            var referenceSpace = renderer.xr.getReferenceSpace();
            var session = renderer.xr.getSession();
            if (hitTestSourceRequested === false) {
                session.requestReferenceSpace('viewer').then(function(referenceSpace) {
                    session.requestHitTestSource({ space: referenceSpace }).then(function(source) {
                        hitTestSource = source;
                    });
                });
                session.addEventListener('end', function() {
                    hitTestSourceRequested = false;
                    hitTestSource = null;
                    isAR = false;
                    reticle.visible = false;
                    document.getElementById("place-button").style.display = "none";
                });
                hitTestSourceRequested = true;
            }
            if (hitTestSource) {
                var hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length) {
                    var hit = hitTestResults[0];
                    document.getElementById("place-button").style.display = "block";
                    reticle.visible = true;
                    reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                } else {
                    reticle.visible = false;
                    document.getElementById("place-button").style.display = "none";
                }
            }
        }
        renderer.render(scene, camera);
    }
</script>


</body>
</html>
